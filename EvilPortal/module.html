<div class="row" ng-controller="EvilPortalController">

    <div class="col-md-3">
        <div class="panel panel-default">
            <div class="panel-heading">
                <a href="javascript:;" data-toggle="collapse" data-target="#collapseControls" class="text-muted"><h4
                        class="panel-title">Controls <img src="/img/throbber.gif" ng-show="throbber"/></h4></a>
            </div>
            <div id="collapseControls" class="panel-collapse collapse in">
                <div class="panel-body">
                    <table style="width:100%">
                        <tr ng-repeat="control in controls" ng-show="control.visible">
                            <td style="padding-bottom: .5em;" class="text-muted">{{ control.title }}</td>
                            <!--<td style="text-align:right">{{ control.status }}</td>-->
                            <td style="text-align:right;padding-bottom: .5em;">
                                <button class="btn btn-default btn-sm" style="width:75px"
                                        ng-click="handleControl(control)" ng-hide="control.throbber">{{ control.status
                                    }}
                                </button>
                                <img src="/img/throbber.gif" ng-show="control.throbber"/>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">
                <a href="javascript:;" data-toggle="collapse" data-target="#collapseMessages" class="text-muted"><h4
                        class="panel-title">Evil Portal Messages</h4></a>
            </div>
            <div id="collapseMessages" class="panel-collapse collapse in">
                <div class="panel-body">
                    <p ng-show="(messages.length == 0)" class="text-muted"><i>No Messages.</i></p>
                    <a ng-hide="(messages.length < 2)" ng-click="messages = []" class="pull-right" href="javascript:;">Clear
                        All</a>
                    <table style="width:100%" ng-hide="(messages.length == 0)">
                        <tr ng-repeat="message in messages">
                            <td>
                                <fieldset>
                                <legend><h5><b>{{ message.title }}</b> <a ng-click="dismissMessage($index)" href="javascript:;"
                                                                  class="pull-right">Dismiss</a></h5></legend>
                                <p class="text-muted"><i>{{ message.msg }}</i></p>
                                </fieldset>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!--<div ng-show="dependencies">-->
    <div class="panel-group" id="accordion">
        <div class="col-md-9">
            <!-- Library panel -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h5 class="panel-title"><a href="javascript:;" data-toggle="collapse" data-parent="#accordion"
                                               data-target="#collapseLibrary" class="text-muted">Work Bench <b><i>{{ workshopPortal.title }}</i></b></a></h5>
                </div>
                <div id="collapseLibrary" class="panel-collapse collapse in">
                    <div class="panel-body">
                        <div class="input-group" ng-show="library">

                            <span class="input-group-btn">
                                <select class="form-control ng-pristine ng-valid ng-touched" style="width:80px" ng-model="newPortalType">
                                    <option value="basic">Basic</option>
                                    <option value="targeted">Targeted</option>
                                </select>
                            </span>

                            <input type="text" class="form-control" placeholder="Portal Name" name="portalName" ng-model="newPortalName">

                            <span class="input-group-btn">
                                <button ng-disabled="newPortalName == ''" class="btn btn-default" type="button" ng-click="createNewPortal('internal')">Create New Portal</button>
                                <button ng-disabled="newPortalName == ''" class="btn btn-default" type="button" ng-click="createNewPortal('sd')" ng-show="sdAvailable">Create On SD Card</button>
                            </span>
                        </div>
                        <hr ng-show="library"/>
                        <div ng-show="portals.length > 0 && library == true">
                            <div class="table-responsive">
                                <table class="table table-striped" align="center">
                                    <thead>
                                    <th>Portal Name</th>
                                    <th>Portal Type</th>
                                    <th>Location</th>
                                    <th ng-show="sdAvailable">Move</th>
                                    <th>Activate</th>
                                    <th>Delete</th>
                                    </thead>
                                    <tbody>
                                    <tr ng-repeat="portal in portals">
                                        <td><a href="javascript:;" ng-click="getPortalFiles(portal)" style="text-transform: capitalize"><b>{{ portal.title }}</b></a></td>
                                        <td class="text-muted" style="text-transform: capitalize"><i>{{ portal.type }}</i></td>
                                        <td class="text-muted" style="text-transform: capitalize"><i>{{ portal.storage }}</i></td>
                                        <td ng-show="sdAvailable && portal.storage == 'internal'"><a href="javascript:;" ng-click="movePortal(portal, 'sd');">Move to SD</a></td>
                                        <td ng-show="sdAvailable && portal.storage == 'sd'"><a href="javascript:;" ng-click="movePortal(portal, 'internal');">Move to Internal</a></td>
                                        <td ng-hide="portal.active"><a href="javascript:;"
                                                                       ng-click="activatePortal(portal)">Activate</a>
                                        </td>
                                        <td ng-show="portal.active"><a href="javascript:;"
                                                                       ng-click="deactivatePortal(portal)">Deactivate</a>
                                        </td>
                                        <td ng-hide="portal.active"><a href="javascript:;" data-toggle="modal"
                                                                       data-target="#deleteModal"
                                                                       ng-click="deletePortalRequest(portal)"
                                                                       ng-hide="portal.storage == 'active'">Delete</a>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div ng-hide="portals.length > 0 || library == false">
                            <p class="text-muted text-center"><i>No Portals in Library to Display.</i></p>
                        </div>

                        <!-- Portal Editor -->
                        <div ng-hide="library">

                            <!-- Editor Buttons -->
                            <div class="row-fluid">
                                <span class="pull-left">
                                    <button type="submit" class="btn btn-default btn-sm" ng-click="library = true; workshopPortal = {}">Back To Library</button>
                                </span>
                                <span class="pull-right">
                                    <button type="submit" class="btn btn-default btn-sm" data-toggle="modal" data-target="#fileModal" ng-click="editPortalFile.portalName = workshopPortal.title; editPortalFile.storage = workshopPortal.storage;">New File</button>
                                    <button type="submit" class="btn btn-default btn-sm" data-toggle="modal" data-target="#ruleEditorModal" ng-show="workshopPortal.type == 'targeted'" ng-click="getPortalRules(workshopPortal);">Rule Editor</button>
                                    <button type="submit" class="btn btn-default btn-sm" ng-click="getPortalFiles(workshopPortal)">Refresh</button>
                                </span>
                            </div>

                            <br/>
                            <hr />

                            <!-- Portal Files -->
                            <div class="table-responsive">
                                <table class="table table-striped" align="center">
                                    <thead>
                                    <th>File Name</th>
                                    <th>Edit</th>
                                    <th>Delete</th>
                                    </thead>
                                    <tbody>
                                    <tr ng-repeat="file in workshopPortal.files">
                                        <td>{{ file.name }}</td>
                                        <td><a href="javascript:;" ng-click="editPortal(workshopPortal, file.name)" data-toggle="modal" data-target="#fileModal">Edit</a></td>
                                        <td><a href="javascript:;" ng-click="requestDeleteFile(file.name, workshopPortal)" data-toggle="modal" data-target="#deleteFileModal" ng-show="file.deletable">Delete</a></td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- EvilPortal White List Panel -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h5 class="panel-title"><a href="javascript:;" data-toggle="collapse" data-parent="#accordion"
                                               data-target="#collapseWhiteList" class="text-muted"
                                               ng-click="getList('whiteList')">White List</a></h5>
                </div>
                <div id="collapseWhiteList" class="panel-collapse collapse">
                    <div class="panel-body">
                        <p class="text-muted">
                            <i>This is a list of clients who are allowed to connect to the internet without ever viewing the captive portal.</i>
                        </p>
                        <p>
                            <textarea id="whiteListPool" class="form-control" rows="15" ng-mouseup="getClickedClient('whiteListPool', 'whiteListInput');" ng-model="whiteList" readonly></textarea>
                        </p>
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="IP Address" name="whiteListInput"
                                   ng-model="whiteListInput">
		                    <span class="input-group-btn">
		                        <button class="btn btn-default" type="button"
                                        ng-click="addWhiteListClient()">Add</button>
		                        <button class="btn btn-default" type="button"
                                        ng-click="removeWhiteListClient()">Remove</button>
		                    </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EvilPortal Authorized Clients Panel -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h5 class="panel-title"><a href="javascript:;" data-toggle="collapse" data-parent="#accordion"
                                               data-target="#collapseAuthorizedClients" class="text-muted"
                                               ng-click="getList('accessList')">Authorized Clients</a></h5>
                </div>
                <div id="collapseAuthorizedClients" class="panel-collapse collapse">
                    <div class="panel-body">
                        <p class="text-muted" ng-show="running">
                            <i>This is a list of clients who have been authorized through the captive portal.</i>
                        </p>
                        <p ng-show="running">
                            <textarea id='authorizedPool' class="form-control" rows="15" ng-mouseup="getClickedClient('authorizedPool', 'accessListInput');" ng-model="accessList" readonly></textarea>
                        </p>
                        <div class="input-group" ng-show="running">
                            <input type="text" class="form-control" placeholder="IP Address" name="accessListInput"
                                   ng-model="accessListInput">
		                    <span class="input-group-btn">
		                        <button class="btn btn-default" type="button"
                                        ng-click="authorizeClient()">Authorize</button>
		                        <button class="btn btn-default" type="button" ng-click="revokeClient()">Revoke</button>
		                    </span>
                        </div>
                        <div ng-hide="running">
                            <p class="text-muted text-center"><i>Evil Portal must be started first.</i></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Preview Panel -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h5 class="panel-title"><a href="javascript:;" data-toggle="collapse" data-parent="#accordion"
                                               data-target="#collapsePreview" ng-click="refreshLivePreview()"
                                               class="text-muted">Live Preview</a></h5>
                </div>
                <div id="collapsePreview" class="panel-collapse collapse">
                    <div class="panel-body">
                        <div ng-show="running">
                            <iframe src="http://172.16.42.1" style="width:100%;height:300px;border:none;"
                                    id="livePreviewIframe"></iframe>
                            <button type="submit" ng-click="refreshLivePreview()" class="btn btn-default btn-sm">
                                Refresh
                            </button>
                        </div>
                        <div ng-hide="running">
                            <p class="text-muted text-center"><i>Evil Portal must be started first.</i></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Change Log Pannel -->
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h5 class="panel-title"><a href="javascript:;" data-toggle="collapse" data-parent="#accordion"
                                               data-target="#collapseChangelog" class="text-muted">Evil Portal Info</a></h5>
                </div>
                <div id="collapseChangelog" class="panel-collapse collapse">
                    <div class="panel-body">
                        <fieldset>
                            <legend>Disclaimer</legend>
                            <p><b>Evil Portal and all of its components are intended for professional use only. No one associated with this project is an anyway liable for your actions.</b></p>
                        </fieldset>
                        <fieldset>
                            <legend>Help</legend>
                            <h5>Summary</h5>
                            <p>Evil Portal is a captive portal program that enables you to easily create a captive portal for whatever your needs are. There are two kinds of portals Basic and Targeted.
                            Basic portals are just a simple page that gets served to all clients. Targeted portals allow you to serve a unique page to different clients based on a given rule.</p>
                            <h5>Basic Portals</h5>
                            <p>A Basic Portal is a one-size serves all kind of portal. These portals are designed to be a single page that all clients will land on. This is the traditional way
                            that captive portals work and the way Evil Portal as been doing things from the beginning.</p>
                            <h5>Targeted Portals</h5>
                            <p>A Targeted Portal allows you to serve a different page on a per-client basis based on a condition. This can be something like their mac address, user-agent, etc...
                            Targeted Portals give you a whole new dynamic to what Evil Portal can do, if you want clients who are connected to the SSID "Coffee Shop" to see a "Coffee Shop" branded portal
                            while at the same time clients with Android phones seeing an Android branded portal then this is what you want.</p>
                            <h5>Useful Links</h5>
                            <a href="https://forums.hak5.org/index.php?/topic/37874-official-evilportal/">Hak5 Forum Thread</a>
                            <br />
                            <a href="https://github.com/frozenjava/EvilPortalNano">GitHub Project</a>
                        </fieldset>
                        <fieldset>
                            <legend>Change Log</legend>
                            <ul>
                                <li><b>3.0</b></li>
                                <ul>
                                    <li class="text-muted">Added ability to route clients to different portals based upon some identifier [ssid, mac vendor, ip, etc...]</li>
                                    <li class="text-muted">Updated the work bench so users can choose between targeted and non-targeted portals</li>
                                    <li class="text-muted">Created easy-to-use interface for creating targeting rules</li>
                                    <li class="text-muted">Created some consistency throughout the UI</li>
                                    <li class="text-muted">Added ability to create portals on an SD card and move between SD and Internal storage easily</li>
                                    <li class="text-muted">Made white listed and authorized clients IP addresses clickable like SSIDs in PineAP</li>
                                    <li class="text-muted">Created helper functions getClientMac, getClientSSID, getClientHostName</li>
                                    <li class="text-muted">Various quality of life improvements</li>
                                </ul>
                            </ul>
                            <ul>
                                <li><b>2.1</b></li>
                                <ul>
                                    <li class="text-muted">Removed un-needed verbosity</li>
                                    <li class="text-muted">Made tab key indent in the editor instead of change elements</li>
                                    <li class="text-muted">Added confirmation dialogue box when deleting a portal</li>
                                    <li class="text-muted">Created auto-start feature</li>
                                    <li class="text-muted">Various other quality of life updates</li>
                                </ul>
                            </ul>
                            <ul>
                                <li><b>2.0</b></li>
                                <ul>
                                    <li class="text-muted">Captive Portal is now purely iptables (because F***
                                        NoDogSplash)
                                    </li>
                                </ul>
                            </ul>
                            <ul>
                                <li><b>1.0</b></li>
                                <ul>
                                    <li class="text-muted">Initial Pineapple Nano Release</li>
                                </ul>
                            </ul>
                        </fieldset>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--</div>-->

    <!-- Edit file modal -->
    <div id="fileModal" class="modal fade" role="dialog">

        <script type="text/javascript">
            // Thanks to sud0nick on forums.hak5.org for this snippet
            $(document).delegate('#evilportalEditor', 'keydown', function(e) {
                var keyCode = e.keyCode || e.which;

                if (keyCode == 9) {
                    e.preventDefault();
                    var start = $(this).get(0).selectionStart;
                    var end = $(this).get(0).selectionEnd;

                    // set textarea value to: text before caret + tab + text after caret
                    $(this).val($(this).val().substring(0, start)
                            + "\t"
                            + $(this).val().substring(end));

                    // put caret at right position again
                    $(this).get(0).selectionStart =
                            $(this).get(0).selectionEnd = start + 1;
                }
            });
        </script>

        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"
                            ng-click="editPortalFile = {}">&times;</button>
                    <h4 class="modal-title" ng-show="editPortalFile.updating">Editing File {{ editPortalFile.file }}</h4>
                    <h4 class="modal-title" ng-hide="editPortalFile.updating">Creating New File</h4>
                </div>
                <div class="modal-body">
                    <form class="form-horizontal">
                        <div class="form-group">
                            <label class="control-label">File Name</label>
                            <input type="text" class="form-control" ng-model="editPortalFile.file" placeholder="Notes.txt" ng-disabled="editPortalFile.updating">
                        </div>
                        <div class="form-group">
                            <label class="control-label">File Contents</label> <a href="javascript:;" ng-click="editPortalFile.code = ''">Clear</a>
                            <textarea class="form-control" rows="10" ng-model="editPortalFile.code"
                                      placeholder="Write some text here" id="evilportalEditor"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" ng-click="savePortalCode(editPortalFile);" class="btn btn-success pull-right" data-dismiss="modal" ng-disabled="editPortalFile.file == ''">Save</button>
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal"
                            ng-click="editPortalFile = {}">Cancel
                    </button>
                </div>
            </div>
        </div>

    </div>

    <!-- Delete Portal Modal -->
    <div id="deleteModal" class="modal fade" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" ng-click="portalToDelete = null; portalDeleteValidation = null">&times;</button>
                    <h4 class="modal-title">Delete Portal <i>{{ portalToDelete.title }}</i>?</h4>
                </div>
                <div class="modal-body">
                    <p>You are about to delete {{ portalToDelete.title }} on {{ portalToDelete.storage }} storage. Once you do this it can not be undone.</p>
                    <p><b>Type the name of the portal you are trying to delete to continue.</b></p>
                    <input type="text" class="form-control" placeholder="PortalName" name="portalName" ng-model="portalDeleteValidation">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal" ng-click="portalToDelete = null; portalDeleteValidation = null">Cancel</button>
                    <button type="button" class="btn btn-danger pull-right" data-dismiss="modal" ng-click="deletePortal(portalToDelete); portalToDelete = {}" ng-disabled="portalDeleteValidation.toLowerCase() != portalToDelete.title.toLowerCase()">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete file Modal -->
    <div id="deleteFileModal" class="modal fade" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" ng-click="deleteFile = {}">&times;</button>
                    <h4 class="modal-title">Delete File <i><b>{{ deleteFile.name }}</b></i>?</h4>
                </div>
                <div class="modal-body">
                    <p>You are about to delete <b>{{ deleteFile.name }}</b>. Once you do this it can not be undone.</p>
                    <p><b>Are you absolutely sure you want to delete <i>{{ deleteFile.name }}</i>?</b></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal" ng-click="deleteFile = {}">Cancel</button>
                    <button type="button" class="btn btn-danger pull-right" data-dismiss="modal" ng-click="sendDeleteFile()">Delete {{ deleteFile.name }}</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rule Editor Modal -->
    <div id="ruleEditorModal" class="modal fade" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" ng-click="">&times;</button>
                    <h4 class="modal-title">Editing Rules for {{ workshopPortal.title }}</h4>
                </div>
                <div class="modal-body">
                    <div ng-repeat="(key, data) in portalRules.rules">
                        <fieldset>
                            <legend style="text-transform: uppercase">{{ key }}</legend>
                            <div ng-repeat="(specifier, values) in data">
                                <h5 style="text-transform: capitalize">{{ specifier }} <a href="javascript:;" data-target="#" ng-click="newPortalRule(key, specifier);">Add Rule</a></h5>
                                <div class="table-responsive" ng-hide="isObjectEmpty(workingPortalRules.rules[key][specifier])">
                                    <table class="table table-striped" align="center">
                                        <thead>
                                        <th>Rule Key</th>
                                        <th>Destination</th>
                                        <!--<th>Commit</th>-->
                                        <th>Remove</th>
                                        </thead>
                                        <tbody>
                                        <tr ng-repeat="(i, rules) in workingPortalRules.rules[key][specifier]">
                                            <td><input type="text" placeholder="Key Value" ng-model="rules.key"></td>
                                            <td><input type="text" placeholder="Destination.php" ng-model="rules.destination"></td>
                                            <!--<td><a href="javascript:;" data-target="#" ng-click="commitPortalRule(key, specifier, i, rules.key, rules.destination)">Commit</a></td>-->
                                            <td><button ng-click="removePortalRule(key, specifier, i)" class="btn btn-sm btn-danger">Remove</button></td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </fieldset>
                        <br />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default pull-left" data-dismiss="modal" ng-click="">Cancel</button>
                    <button type="button" class="btn btn-success pull-right" data-dismiss="modal" ng-click="savePortalRules(workshopPortal)" >Save</button>
                </div>
            </div>
        </div>
    </div>

</div>